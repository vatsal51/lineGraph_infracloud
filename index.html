<!DOCTYPE html>
<html>

<head>
  <title>Line Chart</title>
  <!-- Include Chart.js library -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.23.0"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.js"></script>

<body>

  <div class="container">
    <div class="wrapper">
      <label for="dateRangePicker"><span>Select start and end date :</span>
        <input type="text" id="dateRangePicker" placeholder="Select date range">
      </label>
      <button id="specialEndpointFilter">Filter Special Endpoints</button>
      <button id="resetChart">Reset Chart</button>
    </div>

    <canvas id="lineChart" width="800" height="400"></canvas>
  </div>


</body>
<style>
  * {
    box-sizing: border-box;
  }

  .container {
    margin: 0 auto;
    max-width: 1200px;
    border: 3px solid #c6c6c6;
  }

  .wrapper {
    display: flex;
    gap: 15px;
    padding: 15px;
    margin: 15px;
    background-color: #c6c6c6;

  }

  .wrapper span {
    font-weight: 600;
  }

  .wrapper button,
  .wrapper input {
    font-weight: 600;
    flex: 1 0 auto;
    border: 2px solid cyan;
    background: #fff;
    color: #000;
    border-radius: 25px;
    padding: 10px 20px;
    transition: 0.3s all ease-in-out;
    cursor: pointer;
  }

  .wrapper input {
    border-color: #999;
  }

  .wrapper button:hover {
    background: cyan;
    color: #fff;
  }
</style>
<script>

  const data = [
    { endpoint: "/home", time: '2023-10-08', requests: 2364, special: true },
    { endpoint: "/home", time: '2023-10-07', requests: 1132 },
    { endpoint: "/home", time: '2023-10-06', requests: 3433, special: true },
    { endpoint: "/product", time: '2023-10-07', requests: 1563 },
    { endpoint: "/product", time: '2023-10-06', requests: 1563 },
    { endpoint: "/contact", time: '2023-10-07', requests: 2298, special: true },
    { endpoint: "/product", time: '2023-10-08', requests: 3198, special: true },
    { endpoint: "/contact", time: '2023-10-08', requests: 1950, special: true },
    { endpoint: "/contact", time: '2023-10-06', requests: 2800 },
  ];
  // Iterate through the data and split it based on the endpoint
  function getEndpointData(mapset, data) {
    data.forEach(item => {
      if (!mapset[item.endpoint]) {
        mapset[item.endpoint] = [];
      }
      mapset[item.endpoint].push(item);

    });
  }

  function color(index) {
    let borderColor = 'blue'; // Default color
    if (index === 1) {
      borderColor = 'red';
    } else if (index === 2) {
      borderColor = 'green';
    }
    return borderColor
  }

  // Create objects to store the split data
  const dataMap = {};
  getEndpointData(dataMap, data)

  // Extract unique dates for the x-axis
  const uniqueDates = [];
  for (const item of data) {
    if (!uniqueDates.includes(item.time)) {
      uniqueDates.push(item.time);
    }
  }

  // Sort the dates in ascending order
  uniqueDates.sort();

  // Create an array of labels for the x-axis (time)
  const labels = uniqueDates;

  // Convert the dataMap into an array of arrays
  const result = Object.values(dataMap);

  // Now result contains the split data based on the endpoint

  const ctx = document.getElementById('lineChart').getContext('2d');

  const config_data = {
    labels: labels,
    datasets: result.map((endpointData, index) => {
      return {
        label: endpointData[0].endpoint,
        data: endpointData.map(item => item.requests),
        borderColor: color(index),
        fill: false,
        tension: 0.3
      };
    }),
  };

  // Now we have the chart configuration in config_data with datasets for each endpoint

  const chartConfig = {
    type: 'line', //type of chart i.e line
    data: config_data,
    respossive: true
  };

  const lineChart = new Chart(ctx, chartConfig);

  // Implement user-friendly features

  // Initialize the date range picker
  $('#dateRangePicker').daterangepicker({
    opens: 'left',
    autoApply: true,
    locale: {
      format: 'YYYY-MM-DD', // Specify the date format
    },
  });


  //Filter data by date range
  $('#dateRangePicker').on('apply.daterangepicker', function (ev, picker) {
    const startDate = picker.startDate.toDate();
    const endDate = picker.endDate.toDate();

    // Filter data for the selected time range
    const filteredData = data.filter(item => {
      const itemDate = new Date(item.time);
      return itemDate >= startDate && itemDate <= endDate;
    });

    // Check if there's no data in the filtered result
    if (filteredData.length === 0) {
      alert("No data available for the selected date range."); // Display an error message or perform any other desired action
      // Remove the plotted graph
      lineChart.data.labels = [];
      lineChart.data.datasets = [];
    } else {
      // Split the filtered data based on endpoints
      const filteredDataMap = {};
      getEndpointData(filteredDataMap, filteredData)
      // Update the chart with the filtered data

      const filteredResult = Object.values(filteredDataMap);
      // Sort the dates in ascending order

      // console.log(filteredResult)
      const uniqueDates = [...new Set(filteredResult.flat().map(item => item.time))].sort();

      lineChart.data.labels = uniqueDates;

      filteredResult.forEach(endpointData => {
        endpointData.sort((a, b) => new Date(a.time) - new Date(b.time));
      });

      lineChart.data.datasets = filteredResult.map((endpointData, index) => ({
        label: endpointData[0].endpoint,
        data: endpointData.map(item => item.requests),
        borderColor: color(index),
        fill: false,
        tension: 0.3
      }));
    }

    lineChart.update();
  });

  // Filter data to include only items where 'special' is true
  const filteredData = data.filter(item => item.special === true)
  $('#specialEndpointFilter').on('click', () => {

    // Extract unique dates for the x-axis
    const uniqueDates = [];
    for (const item of data) {
      if (!uniqueDates.includes(item.time)) {
        uniqueDates.push(item.time);
      }
    }

    // Sort the dates in ascending order
    uniqueDates.sort();

    // Create an array of labels for the x-axis (time)
    const labels = uniqueDates;
    const endpointMap = {};
    getEndpointData(endpointMap, filteredData)

    // console.log(endpointMap)
    // Update the chart to display the filtered data for each endpoint
    const updatedDatasets = Object.values(endpointMap).map((endpointData, index) => ({
      label: endpointData[0].endpoint,
      data: labels.map(date => {
        const dataPoint = endpointData.find(item => item.time === date);
        return dataPoint ? dataPoint.requests : null;
      }),
      borderColor: color(index),
      fill: false,
      spanGaps: true,
      tension: 0.3
    }));

    lineChart.data.labels = labels;
    lineChart.data.datasets = updatedDatasets;
    lineChart.update();
  });

  // Store the original chart data when it is initially loaded
  const originalData = {
    labels: lineChart.data.labels,
    datasets: lineChart.data.datasets,
  };


  // Add an event listener for the "Reset Chart" button
  document.getElementById('resetChart').addEventListener('click', () => {
    lineChart.data.labels = originalData.labels;
    lineChart.data.datasets = originalData.datasets;
    lineChart.update();
    // Restore the original data to reset the chart
  });


</script>

</html>